---
title: "Homework 5"
author: "Yuanming Mao"
output: github_document
---

```{r, include=FALSE}
library(tidyverse)
library(rvest)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 4
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

## Problem 1

The raw data collect information on more than 52,000 criminal homicides over the past decade in 50 of the largest American cities. The data included the location of the killing, whether an arrest was made and, in most cases, basic demographic information about each victim.

Read in the data.

```{r}
homicide_df = 
  read.csv("homicide_data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest" ~ "unsolved",
      disposition == "Closed by arrest" ~ "solved"
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```

Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarise(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

prop test for Baltimore

```{r}
prop.test(
  aggregate_df %>%  filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  aggregate_df %>%  filter(city_state == "Baltimore_MD") %>% pull(hom_total)
  ) %>% 
  broom::tidy()
```

prop test for all cities

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```

A plot that shows the estimates and CIs for each city

```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Problem 2

Import and tidy data

```{r}
path_df = 
  tibble(
    path = list.files("lda_data"),
  ) %>% 
  mutate(
    path = str_c("lda_data/", path),
    output_list = map(path,read.csv)
    ) %>% 
  unnest(output_list) %>% 
  mutate(
    arm = case_when(
      str_detect(path,"con") ~ "control",
      str_detect(path,"exp") ~ "experimental"
    ),
    id = str_extract(path, "\\d\\d"),
    id = as.numeric(id)
  ) %>% 
  select(-path) %>% 
  relocate(arm, id) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observation"
  ) %>% 
  mutate(
    week = str_remove(week, "week_"),
    week = as.numeric(week)
    )
```

Spaghetti plot showing observations on each subject over time

```{r}
path_df %>%
  mutate(id = str_c(arm, "_", id)) %>% 
  ggplot(aes(x = week, y = observation, color = arm, group = id)) + 
  geom_line() +
  labs(title = "Spaghetti plot showing observations on each subject over time")
  
```

The baseline values of observation were about the same across groups. The experimental arm experienced more increase in observation values than control group. The observation values of the control group remained about the same from week 1 to week 8.

## Problem 3

Generate the simulation dataframe with t-test results for mu = 0

```{r cache = TRUE}
sim_df = 
  tibble(
    mu = 0,
    sim_data = rerun(5000, rnorm(30, mean = mu, sd = 5))
  ) %>% 
  mutate(
    ttest_output = map(.x = sim_data, ~t.test(.x, mu = 0)),
    tidy_tests = map(.x = ttest_output, ~broom::tidy(.x))
  ) %>% 
  select(-sim_data, -ttest_output) %>% 
  unnest(tidy_tests) %>% 
  select(mu, estimate, p.value)

```



Repeat for mu = 1,2,3,4,5,6

```{r}
sim_df = 
  tibble(
    mu = 
  )
```

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) 

sim_results = 
  tibble(
    sample_size = c(30, 60, 120, 240)
  ) %>% 
  mutate(
    output_lists = map(.x = sample_size, ~ rerun(100, sim_mean_sd(.x))),
    estimate_df = map(output_lists, bind_rows)
  ) %>% 
  select(-output_lists) %>% 
  unnest(estimate_df)
```

